<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="font/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="css/swiper.min.css" />
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/all.css" />
    <link rel="stylesheet" type="text/css" href="css/shop.css" />
    <script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/phone.js" type="text/javascript" charset="utf-8"></script>
</head>
<body style="padding-top: 50px;">
<div id="cart-head" class="show">
    <div class="cart-head">
        <a class="return" href="javascript:history.back(-1);">
            <span class="arrow-left"></span>
        </a>
        <div class="head-title">购物车</div>
        <a class="carhead-right" href="javascript:operation();">管理</a>
    </div>
</div>
<form action="" method="">
    <div class="car-box">
        <ul>
            <li class="car-list">
                <div class="car-address">
                    <span>仓库： 泰州库</span>
					<span class="cartFull-del">删除</span>
                </div>
                <div class="car-goods">
                    <input class="check-goods" checked="checked" type="checkbox" name="" value="" />
                    <span>酸洗卷　SPHC</span>
                    <span class="carGood-mage"><b>2.300*1250.0*C</b>　<t class="goods-weight">8.880</t>吨</span>
                    <span class="carGood-price"><b class="goods-price">4168</b>元/吨</span>
                </div>
				<div class="car-check">
					<input type="checkbox" name="" id="" value="" />加工
					<input type="text" name="" id="" value="" placeholder="填写加工说明" />
				</div>
				<span class="goPin">去拼购</span>
            </li>
            
        </ul>
    </div>
</form>
<div class="footer car-set allset" style="bottom: 52px;">
    <div class="fl clearfix money">
        合计：<i>￥</i><b id="carShop-price">0.00</b><i id="carShop-weight">（0.000吨）</i>
    </div>
</div>
<div class="footer car-set">
    <button class="carSet-all fr" type="button">
        <a href="play-cg.html" style="color: #fff;">计划采购</a>
    </button>
    <button class="carSet-all fr" type="button"><a href="submit-order.html" style="background-color: red;color: #fff;">提交订单</a></button>
    <button class="carSet-empty fr" type="button">清空购物车</button>
    <button class="carSet-del fr" type="button">删除</button>
</div>
<script src="js/user-lottery.js" type="text/javascript" charset="utf-8"></script>
<script src="js/tools.js" type="text/javascript" charset="utf-8"></script>
<script src="js/all.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
$('.check-goods').bind('click', total_calc);

total_calc();

var operation_tag = 0;//0：提交购物车操作，1：删除购物车操作
//提交与操作切换
function operation () {
  if (operation_tag == 0) {
    $('.carhead-right').text('完成');
    $('.carSet-all').hide();
    $('.allset').hide();
    $('.carSet-empty').show();
    $('.carSet-del').show();
    operation_tag = 1;
  } else {
    $('.carhead-right').text('管理');
    $('.carSet-all').show();
    $('.allset').show();
    $('.carSet-empty').hide();
    $('.carSet-del').hide();
    operation_tag = 0;
  }
};

//选中
function is_chose () {
  var ids = '';
  $('.check-goods:checked').each(function () {
    ids += $(this).val() + ',';
  });

}

//总计计算
function total_calc () {
  var all_price = 0;
  var all_weight = 0;
  var price = 0;
  var weight = 0;
  $('.check-goods:checked').each(function () {
    price = parseFloat($(this).parent('.car-goods').find('.goods-price').text());
    weight = parseFloat($(this).parent('.car-goods').find('.goods-weight').text());
    all_weight += weight;
    all_price += price * weight;
  });
  $('#carShop-price').text(all_price.toFixed(2));
  $('#carShop-weight').text('（' + all_weight.toFixed(3) + '吨）');
}
</script>
<script type="text/javascript">
			// 获取购物车商品、优惠券、白条、收货地址列表
			function getPoint(){
				var tkn = getCookie(tk);
				$.ajax({
					url: path + '/linA/listgwc',
					type:'GET',
					data:{},
					beforeSend: function (XMLHttpRequest) {
						XMLHttpRequest.setRequestHeader("token", tkn);
					},
					dataType:'json', //后台返回的数据类型是json文本
					success:function(result) {
						if(result != "" && result.code == 1){
							var shopPoint = result.address //收货地址
								// 收货地址
								for(var k in shopPoint){
									if(shopPoint[k].cIfDefault == 1){
										var pointList =
											'<li class="address-bg" onclick="mrAddress(this)"><p>'+ shopPoint[k].cName + '</p><span>' + shopPoint[k].cPhone +'</span>'+
											'<span>'+ shopPoint[k].cProvince + '&nbsp;&nbsp;' + shopPoint[k].cCity + '&nbsp;&nbsp;' + shopPoint[k].cDistrict +
											'</span><span>' + shopPoint[k].cAddress + '</span><span>' + shopPoint[k].cAddress + '</span></li>';
											$('.addressList').append(pointList);
									}else{
										var pointList2 =
											'<li onclick="mrAddress(this)"><p>'+ shopPoint[k].cName + '</p><span>' + shopPoint[k].cPhone +'</span>'+
											'<span>'+ shopPoint[k].cProvince + '&nbsp;&nbsp;' + shopPoint[k].cCity + '&nbsp;&nbsp;' + shopPoint[k].cDistrict +
											'</span><span>' + shopPoint[k].cAddress + '</span><span>' + shopPoint[k].cAddress + '</span></li>';
											$('.addressList').append(pointList2);
									}
								}
						}
					}
				})
			}
			// 加载购物车
			$(function(){
				var tkn = getCookie(tk);
				$.ajax({
					url: path + '/linA/listgwc',
					type:'GET',
					data:{},
					beforeSend: function (XMLHttpRequest) {
						XMLHttpRequest.setRequestHeader("token", tkn);
					},
					dataType:'json', //后台返回的数据类型是json文本
					success:function(result) {
						if(result != "" && result.code == 1){
							var shopCart = result.data;  //购物车商品
							var shopEve = result.coupon  //优惠券
							var shopIous = result.whiteNote //白条
							var shopPoint = result.address //收货地址
							$('.cart-num').html(shopCart.length);
							if(shopCart.length == 0){
								$('.cart-empty').removeClass('hidden');
							}else{
								$('.cartFull-box').removeClass('hidden');
								for(var i in shopCart){
									var cartList = 
									'<tbody><tr><td class="cartFull-address" colspan="8">'+
									'<input type="checkbox" name="" id="" value="" />'+ '<span class="hidden">'+ shopCart[i].stId + '</span>' +
									'<span>地点</span>'+'仓库地址：'+ shopCart[i].stStoreaddress + '</td>' +
									'<td class="cartFull-time">' + shopCart[i].stCreatettime + '</td>'+
									'</tr><tr class="cartFull-mage"><td>' + shopCart[i].stShopName + '&nbsp;&nbsp;&nbsp;' + shopCart[i].stProductName + '</td><td>' + shopCart[i].stProducttexture + '</td>'+
									'<td>'+ shopCart[i].stProducttexture + shopCart[i].stProductspec + '</td><td><span class="weightList">' + shopCart[i].stTonnum + '</span>吨</td>'+
									'<td>' + shopCart[i].stPrice +'￥</td><td><span class="priceList">' + shopCart[i].stNowPrice + '</span>￥</td>'+
									'<td class="forMake"><input type="checkbox" name="" id="" value="" onchange="toMake(this)" />加工'+
									'<span class="toMake" onclick="writeMake(this)">备注信息</span><br><textarea></textarea></td>'+
									'<td><a class="toPin" href="group-pin.html">去拼购</a></td>'+
									'<td><span class="cartFull-del" onclick="oneDel(this,\''+ shopCart[i].stId + '\')">删除</span></td></tr></tbody>';
									$('.cartFull-table').append(cartList);
								};
								// 优惠券
								for(var j in shopEve){
									var EveList = 
										'<div class="sale-list"><input type="radio" onchange="yhChange()" name="sale" id="' + shopEve[j].cId + '" value="' + shopEve[j].cPrice + '" />'+
										'<label for="' + shopEve[j].cId + '">' + shopEve[j].cName + '：' + shopEve[j].cPrice + '元</label></div>';
										$('.saleBox').append(EveList);
									
								};
								// 白条
								// $('.iousNum-list1').html(shopIous.)
								// 收货地址
								getPoint();
								allPrice();
							}
							
						}
					}
				})
			});
			// 添加收货地址
			function addPoint(){
				var tkn = getCookie(tk);
				var setCheck = 1;
				var json = JSON.stringify({
					cName: $('#CuserName').val(),
					cPhone: $('#CuserPhone').val(),
					cProvince: $('#CmyProvince').val(),
					cCity: $('#CmyCity').val(),
					cDistrict: $('#CmyArea').val(),
					cAddress: $('#CmyAddress').val(),
					cZipcode: $('#Cinvoice').val(),
					cIfDefault: setCheck
				});
				$.ajax({
					url: path + '/linA/adddz',
					type: 'post',
					beforeSend: function(XMLHttpRequest) {
						XMLHttpRequest.setRequestHeader("token", tkn);
					},
					data: json,
					contentType: 'application/json;charset=utf-8',
					dataType: 'json', //后台返回的数据类型是json文本
					success: function(result) {
						if (result != "" && result.code == 1) {
							alert('添加成功！')
							$('.addressList').html('');
							$('.userAdd-box').hide();
							getPoint();
						} else {
							alert(result.msg)
						}
					}
				})
			}
			// 单个商品删除
			function oneDel(thiz,oneId){
				var tkn = getCookie(tk);
				$.ajax({
					url: path + '/linA/delgwc',
					type:'POST',
					beforeSend: function (XMLHttpRequest) {
						XMLHttpRequest.setRequestHeader("token", tkn);
					},
					data:{
						id:oneId
					},
					// contentType: 'application/json;charset=utf-8',
					dataType:'json', //后台返回的数据类型是json文本
					success:function(result){
						if(result != "" && result.code == 1){
							alert(result.msg)
							var cartNum = parseInt($('.cart-num').html());
							$('.cart-num').html(cartNum - 1);
							$(thiz).parents('tbody').remove();
							allPrice();
						}else{
							alert(result.msg)
						}
					}
				})
			};
			// 清空购物车
			function allDel(){
				var tkn = getCookie(tk);
				$.ajax({
					url: path + '/linA/delallgwc',
					type:'POST',
					beforeSend: function (XMLHttpRequest) {
						XMLHttpRequest.setRequestHeader("token", tkn);
					},
					data:{},
					// contentType: 'application/json;charset=utf-8',
					dataType:'json', //后台返回的数据类型是json文本
					success:function(result){
						if(result != "" && result.code == 1){
							alert(result.msg)
							$('.cart-num').html('0');
							$('.cart-empty').removeClass('hidden');
							$('.cartFull-box').addClass('hidden');
							allPrice();
						}else{
							alert(result.msg)
						}
					}
				})
			};
			// 商品重量
			function allWeight(){
				var myWeight = 0;
				$(".weightList").each(function () {
					var allList = $(this).text();
					myWeight += allList;
				})
				$(".priceR strong").html((myWeight).toFixed(2)+'吨');
			};
			// 商品总价
			function allPrice(){
				var myPrice = 0;
				var yhPrice = $(".saleBox input[type='radio']:checked").val();
				var btPrice;
				$(".priceList").each(function () {
					var allList = $(this).text();
					myPrice += allList;
				})
				if($('#iousType').is(':checked')){
					btPrice = $('.iousUse input').val();
				}else{
					btPrice = 0;
				}
				myPrice = myPrice - yhPrice - btPrice;
				if(myPrice<0){
					myPrice = 0;
				}
				$(".priceR strong").html((myPrice).toFixed(2));
			};
			$('.iousUse input').change(function(){
				var nowPrice = parseInt($('.priceR strong').html()).toFixed(2);
				var nowNum = parseInt($(this).val()).toFixed(2) ;
				var nowCj = nowNum - nowPrice;
				console.log(nowCj)
				if(nowCj > 0){
					alert(1)
					$(this).val(nowPrice)
				}
				allPrice()
			});
			function yhChange(){
				var yhPrice = $(".saleBox input[type='radio']:checked").val();
				allPrice()
			}
		</script>
	
</body>
</html>
